/script HealSequence()


function HealSequence()
    -- ===== CONFIGURABLE SETTINGS =====
    local SWIFTMEND_THRESHOLD = 0.50  
    local HT_RANK = 3                 
    local REGROWTH_RANK = 0
    local REJUVENATION_RANK = 0
    -- ==================================
    
    -- Determine heal target
    local t = "player"
    if UnitExists("target") and UnitIsFriend("player", "target") and not UnitIsDeadOrGhost("target") then
        t = "target"
    end
    local self = (t == "player") and 1 or nil
    
    -- Get spell name with rank
    local function GetSpellNameWithRank(baseName, rank)
        if rank == 0 then
            return baseName
        else
            return baseName .. "(Rank " .. rank .. ")"
        end
    end
    
    -- Check if we're in Tree of Life form
    local function IsInTreeForm()
        return buffed("Tree of Life Form", "player") or buffed("Tree of Life Aura", "player")
    end
    
    -- Check if we can cast a spell
    local function CanCastSpell(spellName)
        local baseName = spellName
        local _, _, base = string.find(spellName, "(.+)%(Rank %d+%)")
        if base then
            baseName = base
        end
        
        local i = 1
        while true do
            local name = GetSpellName(i, BOOKTYPE_SPELL)
            if not name then break end
            if name == baseName then
                local start, duration = GetSpellCooldown(i, BOOKTYPE_SPELL)
                return start == 0
            end
            i = i + 1
        end
        return false
    end
    
    -- Get target's health percentage and form status
    local targetHealth = UnitHealth(t) / UnitHealthMax(t)
    local inTreeForm = IsInTreeForm()
    
    -- Get spell names with proper ranks
    local rejuvenationSpell = GetSpellNameWithRank("Rejuvenation", REJUVENATION_RANK)
    local regrowthSpell = GetSpellNameWithRank("Regrowth", REGROWTH_RANK)
    local healingTouchSpell = GetSpellNameWithRank("Healing Touch", HT_RANK)
    local swiftmendSpell = "Swiftmend"
    
    -- Priority Order Logic
    local spellToCast = nil
    
    if targetHealth <= SWIFTMEND_THRESHOLD and 
       (buffed("rejuvenation", t) or buffed("regrowth", t)) and
       CanCastSpell(swiftmendSpell) then
        spellToCast = swiftmendSpell
    elseif not buffed("rejuvenation", t) then 
        spellToCast = rejuvenationSpell
    elseif not buffed("regrowth", t) then 
        spellToCast = regrowthSpell
    else
        if inTreeForm then
            spellToCast = regrowthSpell
        else
            spellToCast = healingTouchSpell
        end
    end
    
    -- Cast the spell
    if spellToCast and CanCastSpell(spellToCast) then
        cast(spellToCast, self)
    end
end
