/script CatCombat()


function CatCombat()
    -- EASY CONFIGURATION - Change these values as needed
    local mainDamage = "Claw"           -- "Claw", "Shred", "Rake"
    local finisher = "Ferocious Bite"              -- "Rip", "Ferocious Bite"
    local useRake = true                -- true/false - apply Rake DoT
    local useTigerFury = true           -- true/false - use Tiger's Fury
    local useFaerieFire = true          -- true/false - apply Faerie Fire (Feral)
    local minComboForFinisher = 4       -- 3, 4, or 5 combo points
    local autoAttack = true             -- true/false - manage auto attack
    
    -- Helper function to find spell slot
    local function GetSpellSlot(spellName)
        local i = 1
        while true do
            local name = GetSpellName(i, BOOKTYPE_SPELL)
            if not name then
                break
            end
            if name == spellName then
                return i
            end
            i = i + 1
        end
        return nil
    end
    
    -- Helper function to check if Tiger's Fury is active (vanilla method)
    local function HasTigerFury()
        local i = 0
        while true do
            local buffIndex = GetPlayerBuff(i)
            if buffIndex == -1 then
                break
            end
            local texture = GetPlayerBuffTexture(buffIndex)
            if texture and string.find(texture, "Ability_Mount_JungleTiger") then
                return true
            end
            i = i + 1
        end
        return false
    end
    
    -- Main logic starts here
    local comboPoints = GetComboPoints()
    local energy = UnitMana("player")
    local targetExists = UnitExists("target")
    
    -- Shift to cat form if not in cat form
    if UnitPowerType("player") ~= 3 then
        cast("Cat Form")
        return
    end
    
    -- No target check
    if not targetExists then
        return
    end
    
    -- Auto attack
    if autoAttack and not PlayerFrame.inCombat and targetExists then
        AttackTarget()
    end
    
    -- Apply Faerie Fire (Feral) if enabled and not on target - HIGHEST PRIORITY
    if useFaerieFire and energy >= 35 then
        local hasFaerieFire = false
        for i = 1, 16 do
            local texture = UnitDebuff("target", i)
            if texture and string.find(texture, "Spell_Nature_FaerieFire") then
                hasFaerieFire = true
                break
            end
        end
        if not hasFaerieFire then
            -- Check if Faerie Fire (Feral) is off cooldown before casting
            local faerieFireSlot = GetSpellSlot("Faerie Fire (Feral)")
            if faerieFireSlot then
                local start, duration = GetSpellCooldown(faerieFireSlot, BOOKTYPE_SPELL)
                if start == 0 then -- Only cast if it's off cooldown
                    cast("Faerie Fire (Feral)()")
                    return
                end
            end
        end
    end
    
    -- PRIORITY: Tiger's Fury management - keep it up at all times if enabled
    if useTigerFury then
        local hasTigerFury = HasTigerFury()
        if not hasTigerFury then
            local tigerFurySlot = GetSpellSlot("Tiger's Fury")
            if tigerFurySlot then
                local start, duration = GetSpellCooldown(tigerFurySlot, BOOKTYPE_SPELL)
                if start == 0 then -- Only check if it's off cooldown
                    cast("Tiger's Fury")
                    return
                end
            end
        end
    end
    
    -- Check if target is immune to bleed (elementals, mechanicals, some undead)
    local targetImmuneToBleed = false
    local creatureType = UnitCreatureType("target")
    if creatureType == "Elemental" or creatureType == "Mechanical" then
        targetImmuneToBleed = true
    end
    
    -- Finisher logic
    if comboPoints >= minComboForFinisher then
        local finisherToUse = finisher
        
        -- Switch to Ferocious Bite if target is bleed immune and we want Rip
        if targetImmuneToBleed and finisher == "Rip" then
            finisherToUse = "Ferocious Bite"
        end
        
        -- Check if Rip is already on target (simple check)
        if finisher == "Rip" and not targetImmuneToBleed then
            local hasRip = false
            for i = 1, 16 do
                local texture = UnitDebuff("target", i)
                if texture and string.find(texture, "Ability_GhoulFrenzy") then
                    hasRip = true
                    break
                end
            end
            -- If Rip is already up, use Ferocious Bite instead
            if hasRip then
                finisherToUse = "Ferocious Bite"
            end
        end
        
        cast(finisherToUse)
        return
    end
    
    -- Apply Rake if enabled and not on target
    if useRake and not targetImmuneToBleed and energy >= 40 then
        local hasRake = false
        for i = 1, 16 do
            local texture = UnitDebuff("target", i)
            if texture and string.find(texture, "Ability_Druid_Disembowel") then
                hasRake = true
                break
            end
        end
        if not hasRake then
            cast("Rake")
            return
        end
    end
    
    -- Main damage ability
    if energy >= 40 then -- Simplified energy check
        cast(mainDamage)
        return
    end
end
