function AutoReju()
    -- ===== CONFIGURABLE SETTINGS =====
    local HEALTH_THRESHOLD = 95
    local REJUV_COST = 360
    local REJUV_BLOCK_TIME = 12
    local REJUVENATION_RANK = 0
    -- ==================================

    local start, duration = GetSpellCooldown(154, BOOKTYPE_SPELL)
    if start > 0 and (GetTime() - start) < duration then return end
    

    if UnitMana("player") < REJUV_COST then return end
    if not RejuvDateTimes then RejuvDateTimes = {} end
    if not GCDFrame then GCDFrame = CreateFrame("Frame") end
    
    local oldTarget = UnitName("target")
    
    local function ShouldSkipRejuv(unitName)
        local lastCastTime = RejuvDateTimes[unitName]
        if lastCastTime then
            local currentTime = GetTime()
            local elapsed = currentTime - lastCastTime
            if elapsed < REJUV_BLOCK_TIME then
                return true
            else
                RejuvDateTimes[unitName] = nil
            end
        end
        return false
    end
    
    -- ADDED: Function to check if Rejuvenation is castable (like HEAL SEQUENCE)
    local function CanCastRejuvenation()
        local i = 1
        while true do
            local name = GetSpellName(i, BOOKTYPE_SPELL)
            if not name then break end
            if name == "Rejuvenation" then
                local start, duration = GetSpellCooldown(i, BOOKTYPE_SPELL)
                return start == 0
            end
            i = i + 1
        end
        return false
    end
    
    local function HasReju(unit)
        if not UnitExists(unit) then return false end
        for i = 1, 16 do
            local texture = UnitBuff(unit, i)
            if texture and (string.find(texture, "Spell_Nature_Rejuvenation") or string.find(texture, "Rejuvenation")) then
                return true
            end
        end
        for i = 0, 15 do
            local buff = GetPlayerBuff(i, unit)
            if buff ~= -1 then
                local texture = GetPlayerBuffTexture(buff)
                if texture and (string.find(texture, "Spell_Nature_Rejuvenation") or string.find(texture, "Rejuvenation")) then
                    return true
                end
            end
        end
        return false
    end
    
    local function NeedsHeal(unit)
        if not UnitExists(unit) or UnitIsDead(unit) then return false end
        if not UnitIsFriend("player", unit) then return false end
        if HasReju(unit) then return false end
        local unitName = UnitName(unit)
        if not unitName then return false end
        if ShouldSkipRejuv(unitName) then return false end
        local hp = UnitHealth(unit)
        local maxhp = UnitHealthMax(unit)
        if hp == 0 or maxhp == 0 then return false end
        return (hp / maxhp * 100) <= HEALTH_THRESHOLD
    end
    
    local function GetHealthPercent(unit)
        if not UnitExists(unit) then return 100 end
        local hp = UnitHealth(unit)
        local maxhp = UnitHealthMax(unit)
        if maxhp == 0 then return 100 end
        return (hp / maxhp * 100)
    end
    
    local function CastReju(unit)
        local unitName = UnitName(unit)
        if not unitName then return false end
        
        -- ADDED: Check if Rejuvenation is castable before attempting
        if not CanCastRejuvenation() then return false end
        
        TargetUnit(unit)
        if UnitExists("target") then
            if CheckInteractDistance("target", 4) or SpellIsTargeting() then
                local rejuvenationSpell = (REJUVENATION_RANK == 0) and "Rejuvenation()" or "Rejuvenation(Rank " .. REJUVENATION_RANK .. ")"
                cast(rejuvenationSpell)
                
                -- FIXED: Implement GCD success detection like HEAL SEQUENCE
                GCDFrame.checkTime = GetTime() + 0.3
                GCDFrame.targetName = unitName
                
                GCDFrame:SetScript("OnUpdate", function()
                    if GetTime() >= GCDFrame.checkTime then
                        -- Check if GCD is still active using reliable spell slot
                        local start, duration = GetSpellCooldown(154, BOOKTYPE_SPELL)
                        local gcdRemaining = 0
                        if start and duration and duration > 0 then
                            gcdRemaining = (start + duration) - GetTime()
                        end
                        
                        if gcdRemaining > 0 then
                            -- Cast succeeded, blacklist the target
                            RejuvDateTimes[GCDFrame.targetName] = GetTime()
                        end
                        
                        -- Clean up
                        GCDFrame:SetScript("OnUpdate", nil)
                        GCDFrame.checkTime = nil
                        GCDFrame.targetName = nil
                    end
                end)
                
                return true
            end
        end
        return false
    end
    
    local targets = {}
    
    if NeedsHeal("mouseover") then
        local unitName = UnitName("mouseover")
        if unitName then
            table.insert(targets, {unit = "mouseover", name = unitName, health = GetHealthPercent("mouseover"), priority = 1})
        end
    end
    
    if NeedsHeal("target") then
        local unitName = UnitName("target")
        if unitName then
            table.insert(targets, {unit = "target", name = unitName, health = GetHealthPercent("target"), priority = 2})
        end
    end
    
    for i = 1, 4 do
        local unit = "party" .. i
        if NeedsHeal(unit) then
            local unitName = UnitName(unit)
            if unitName then
                table.insert(targets, {unit = unit, name = unitName, health = GetHealthPercent(unit), priority = 3})
            end
        end
    end
    
    for i = 1, 40 do
        local unit = "raid" .. i
        if NeedsHeal(unit) then
            local unitName = UnitName(unit)
            if unitName then
                table.insert(targets, {unit = unit, name = unitName, health = GetHealthPercent(unit), priority = 4})
            end
        end
    end
    
    if NeedsHeal("player") then
        local unitName = UnitName("player")
        if unitName then
            table.insert(targets, {unit = "player", name = unitName, health = GetHealthPercent("player"), priority = 5})
        end
    end
    
    table.sort(targets, function(a, b)
        if a.priority ~= b.priority then
            return a.priority < b.priority
        else
            return a.health < b.health
        end
    end)
    
    for _, target in targets do
        if CastReju(target.unit) then
            if oldTarget then TargetByName(oldTarget) end
            return
        end
    end
    
    if oldTarget then TargetByName(oldTarget) end
end
