/cast [myrawpower:<=0] Reshift
/script CatCombat()


function CatCombat()
    -- CONFIG
    local mainDamage = "Claw"           -- "Claw", "Shred"
    local finisher = "Rip"   -- "Rip", "Ferocious Bite"
    local useRake = true
    local useTigerFury = true
    local useFaerieFire = true
    local minComboForFinisher = 1
    local autoAttack = true
    
    -- Helper functions
    local function GetSpellSlot(spellName)
        local i = 1
        while true do
            local name = GetSpellName(i, BOOKTYPE_SPELL)
            if not name then break end
            if name == spellName then return i end
            i = i + 1
        end
        return nil
    end
    
    local function HasTigerFury()
        local i = 0
        while true do
            local buffIndex = GetPlayerBuff(i)
            if buffIndex == -1 then break end
            local texture = GetPlayerBuffTexture(buffIndex)
            if texture and string.find(texture, "Ability_Mount_JungleTiger") then
                return true
            end
            i = i + 1
        end
        return false
    end
    
    -- Main logic
    local comboPoints = GetComboPoints()
    local energy = UnitMana("player")
    local targetExists = UnitExists("target")
    
    -- Cat form check
    if UnitPowerType("player") ~= 3 then
        CastSpellByName("Cat Form")
        return
    end
    
    -- Target check
    if not targetExists then return end
    
    -- Auto attack
    if autoAttack and not IsCurrentAction(1) and targetExists then
        AttackTarget()
    end
    
    -- Faerie Fire priority
    if useFaerieFire and energy >= 35 then
        local hasFaerieFire = false
        for i = 1, 16 do
            local texture = UnitDebuff("target", i)
            if texture and string.find(texture, "Spell_Nature_FaerieFire") then
                hasFaerieFire = true
                break
            end
        end
        if not hasFaerieFire then
            local slot = GetSpellSlot("Faerie Fire (Feral)")
            if slot then
                local start = GetSpellCooldown(slot, BOOKTYPE_SPELL)
                if start == 0 then
                    CastSpellByName("Faerie Fire (Feral)()")
                    return
                end
            end
        end
    end
    
    -- Tiger's Fury management
    if useTigerFury then
        local hasTigerFury = HasTigerFury()
        if not hasTigerFury then
            local slot = GetSpellSlot("Tiger's Fury")
            if slot then
                local start = GetSpellCooldown(slot, BOOKTYPE_SPELL)
                if start == 0 and energy >= 30 then
                    CastSpellByName("Tiger's Fury")
                    return
                end
            end
        end
    end
    
    -- Bleed immunity check
    local targetImmuneToBleed = false
    local creatureType = UnitCreatureType("target")
    if creatureType == "Elemental" or creatureType == "Mechanical" or creatureType == "Undead" then
        targetImmuneToBleed = true
    end
    
    -- Finisher logic
    if comboPoints >= minComboForFinisher then
        local finisherToUse = finisher
        
        if targetImmuneToBleed and finisher == "Rip" then
            finisherToUse = "Ferocious Bite"
        end
        
        if finisher == "Rip" and not targetImmuneToBleed then
            local hasRip = false
            for i = 1, 16 do
                local texture = UnitDebuff("target", i)
                if texture and string.find(texture, "Ability_GhoulFrenzy") then
                    hasRip = true
                    break
                end
            end
            if hasRip then
                finisherToUse = "Ferocious Bite"
            end
        end
        
        CastSpellByName(finisherToUse)
        return
    end
    
    -- Apply Rake
    if useRake and not targetImmuneToBleed and energy >= 40 then
        local hasRake = false
        for i = 1, 16 do
            local texture = UnitDebuff("target", i)
            if texture and string.find(texture, "Ability_Druid_Disembowel") then
                hasRake = true
                break
            end
        end
        if not hasRake then
            CastSpellByName("Rake")
            return
        end
    end
    
    -- Main damage ability
    if energy >= 40 then
        CastSpellByName(mainDamage)
        return
    end
end
