/script BearCombat()


function BearCombat()
    -- CONFIG
    local useFaerieFire = true
    local useDemoRoar = true
    local autoAttack = true
    local demoRoarRageThreshold = 30

    -- Helper functions
    local function GetSpellSlot(spellName)
        local i = 1
        while true do
            local name = GetSpellName(i, BOOKTYPE_SPELL)
            if not name then break end
            if name == spellName then return i end
            i = i + 1
        end
        return nil
    end

    local function IsSpellOnCooldown(spellName)
        local slot = GetSpellSlot(spellName)
        if slot then
            local start = GetSpellCooldown(slot, BOOKTYPE_SPELL)
            return start > 0
        end
        return true
    end

    local function HasDebuff(debuffTexture)
        for i = 1, 16 do
            local texture = UnitDebuff("target", i)
            if texture and string.find(texture, debuffTexture) then
                return true
            end
        end
        return false
    end

    -- Main logic
    local rage = UnitMana("player")
    local targetExists = UnitExists("target")

    -- Bear form check
    if UnitPowerType("player") ~= 1 then
        CastSpellByName("Dire Bear Form")
        return
    end

    -- Target check and auto-target nearest
    if not targetExists then
        TargetNearestEnemy()
        targetExists = UnitExists("target")
        if not targetExists then return end
    end

    -- Auto attack - only start if not already in combat
    if autoAttack and not UnitAffectingCombat("player") and targetExists then
        AttackTarget()
    end

    -- Growl for threat (no rage cost)
    if not IsSpellOnCooldown("Growl") then
        CastSpellByName("Growl")
        return
    end

    -- Faerie Fire priority (no rage cost)
    if useFaerieFire then
        local hasFaerieFire = HasDebuff("Spell_Nature_FaerieFire")
        if not hasFaerieFire and not IsSpellOnCooldown("Faerie Fire (Feral)") then
            CastSpellByName("Faerie Fire (Feral)()")
            return
        end
    end

    -- Demoralizing Roar at 40+ rage
    if useDemoRoar and rage >= demoRoarRageThreshold then
        local hasDemoRoar = HasDebuff("Ability_Druid_DemoralizingRoar")
        if not hasDemoRoar and not IsSpellOnCooldown("Demoralizing Roar") then
            CastSpellByName("Demoralizing Roar")
            return
        end
    end

    -- High rage rotation (60+)
    if rage >= 60 then
        -- Swipe if available
        if not IsSpellOnCooldown("Swipe") then
            CastSpellByName("Swipe")
            return
        end
        -- Maul if Swipe on cooldown
        if rage >= 15 then
            CastSpellByName("Maul")
            return
        end
    end

    -- Medium/Low rage rotation (20+)
    if rage >= 20 then
        -- Maul as primary rage spender/builder
        if rage >= 15 then
            CastSpellByName("Maul")
            return
        end
    end
end
