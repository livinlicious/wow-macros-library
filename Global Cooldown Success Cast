/script GlobalCooldownSuccessCast()

function GlobalCooldownSuccessCast()
    if not RejuvDateTimes then RejuvDateTimes = {} end
    if not GCDFrame then
        GCDFrame = CreateFrame("Frame")
    end
    
    local t = "player"
    if UnitExists("target") and UnitIsFriend("player", "target") and not UnitIsDeadOrGhost("target") then
        t = "target"
    end
    local unitName = UnitName(t)
    local self = (t == "player") and 1 or nil
    
    -- Check blacklist
    local lastCast = RejuvDateTimes[unitName]
    if lastCast and (GetTime() - lastCast) < 12 then
        print("BLOCKED - blacklist active")
        return
    end
    
    print("Attempting cast on " .. unitName)
    cast("Rejuvenation", self)
    
    -- Check GCD after a small delay (300ms)
    GCDFrame.checkTime = GetTime() + 0.3
    GCDFrame.targetName = unitName
    
    GCDFrame:SetScript("OnUpdate", function()
        if GetTime() >= GCDFrame.checkTime then
            -- Check if GCD is still active
            local start, duration = GetSpellCooldown(154, BOOKTYPE_SPELL)
            local gcdRemaining = 0
            if start and duration and duration > 0 then
                gcdRemaining = (start + duration) - GetTime()
            end
            
            print("GCD remaining: " .. string.format("%.2f", gcdRemaining) .. "s")
            
            if gcdRemaining > 0 then
                print("GCD STILL ACTIVE - Spell succeeded! Blacklisting")
                RejuvDateTimes[GCDFrame.targetName] = GetTime()
            else
                print("NO GCD - Spell failed, not blacklisting")
            end
            
            -- Clean up
            GCDFrame:SetScript("OnUpdate", nil)
            GCDFrame.checkTime = nil
            GCDFrame.targetName = nil
        end
    end)
end
