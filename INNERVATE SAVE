#showtooltip Innervate
/script InnervatePlayer()


function InnervatePlayer()
    -- ===== CONFIGURABLE SETTINGS =====
    local ENABLE_YELL = true          -- Set to false to disable yelling
    local ENABLE_WHISPER = true       -- Set to false to disable whispering
    local MAX_MANA_PERCENT = 100      -- Only cast if target has LESS than this % mana
    local SKIP_SELF_MESSAGES = true   -- Set to false to announce self-innervates too
    -- ==================================
    
    -- Initialize GCD detection frame
    if not InnervateGCDFrame then
        InnervateGCDFrame = CreateFrame("Frame")
    end
    
    local targetName = UnitName("target")
    if not targetName then
        return
    end

    -- Must be a mana user
    if UnitPowerType("target") ~= 0 then
        return
    end

    -- Check if target has low enough mana to warrant innervate
    local mana = UnitMana("target")
    local maxMana = UnitManaMax("target")
    local manaPercent = (mana / maxMana) * 100
  
    if manaPercent >= MAX_MANA_PERCENT then
        return
    end

    -- Check if we're innervating ourselves
    local isSelf = (targetName == UnitName("player"))
    
    -- Attempt to cast Innervate (no chat output)
    CastSpellByName("Innervate")
    
    -- Set up delayed GCD check using Rejuvenation slot 154 (universal GCD)
    InnervateGCDFrame.checkTime = GetTime() + 0.3
    InnervateGCDFrame.targetName = targetName
    InnervateGCDFrame.isSelf = isSelf
    InnervateGCDFrame.enableYell = ENABLE_YELL
    InnervateGCDFrame.enableWhisper = ENABLE_WHISPER
    InnervateGCDFrame.skipSelfMessages = SKIP_SELF_MESSAGES
    
    InnervateGCDFrame:SetScript("OnUpdate", function()
        if GetTime() >= InnervateGCDFrame.checkTime then
            -- Check universal GCD using Rejuvenation slot 154
            local start, duration = GetSpellCooldown(154, BOOKTYPE_SPELL)
            local gcdRemaining = 0
            if start and duration and duration > 0 then
                gcdRemaining = (start + duration) - GetTime()
            end
            
            if gcdRemaining > 0 then
                -- Cast succeeded - send messages
                -- Skip messages if it's self-innervate and SKIP_SELF_MESSAGES is true
                if not (InnervateGCDFrame.isSelf and InnervateGCDFrame.skipSelfMessages) then
                    -- Yell the message if enabled
                    if InnervateGCDFrame.enableYell then
                        SendChatMessage("Innervate successful casted on " .. InnervateGCDFrame.targetName .. "!", "YELL")
                    end
                    -- Whisper the target if enabled (and not self)
                    if InnervateGCDFrame.enableWhisper and not InnervateGCDFrame.isSelf then
                        SendChatMessage("Innervate successful casted on YOU!", "WHISPER", nil, InnervateGCDFrame.targetName)
                    end
                end
            end
            
            -- Clean up (always clean up, whether success or failure)
            InnervateGCDFrame:SetScript("OnUpdate", nil)
            InnervateGCDFrame.checkTime = nil
            InnervateGCDFrame.targetName = nil
            InnervateGCDFrame.isSelf = nil
            InnervateGCDFrame.enableYell = nil
            InnervateGCDFrame.enableWhisper = nil
            InnervateGCDFrame.skipSelfMessages = nil
        end
    end)
end
